<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialConnect - Real-Time Help Network</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* تمام موجودہ CSS اسٹائلز یہاں رہیں گی */
        /* میں نے انہیں چھوٹ دیا ہے کیونکہ وہ پہلے سے مکمل ہیں */
    </style>
</head>
<body>
    <!-- ہیڈر نیویگیشن (پہلے جیسا ہی) -->
    
    <div class="container">
        <!-- سائیڈبار (پہلے جیسا ہی) -->
        
        <!-- مین کنٹینٹ ایریا -->
        <main class="main-content">
            <!-- پوسٹ بنائیں سیکشن -->
            <section class="create-post">
                <h2 id="post-heading">Create a Help Offer</h2>
                <form class="post-form" id="post-form">
                    <textarea id="post-content" placeholder="What kind of help can you offer? Be specific about your skills and availability..."></textarea>
                    <div class="post-options">
                        <div class="category-select">
                            <select id="post-category">
                                <option value="">Select a category</option>
                                <option>Emotional Support</option>
                                <option>Technical Help</option>
                                <option>Physical Aid</option>
                                <option>Daily Tasks</option>
                                <option>Education</option>
                                <option>Health</option>
                            </select>
                        </div>
                        <button type="submit" class="post-button">Post Offer</button>
                    </div>
                </form>
            </section>
            
            <!-- پوسٹس فیڈ -->
            <section class="posts-feed" id="posts-feed">
                <h2 class="sr-only">Help Requests Feed</h2>
                <!-- پوسٹس یہاں ڈائنامکلی لوڈ ہوں گی -->
            </section>
        </main>
    </div>
    
    <!-- چیٹ بٹن -->
    <div class="chat-button" id="chat-button" aria-label="Open chat">
        <i class="fas fa-comment-dots"></i>
        <div class="chat-badge" id="unread-count">0</div>
    </div>
    
    <!-- موبائل مینو (پہلے جیسا ہی) -->

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>

    <!-- لوکیشن کے لیے اضافی لائبریریز -->
    <script src="https://unpkg.com/geofirestore@6.0.0/dist/geofirestore.min.js"></script>
    
    <script>
        // Firebase کنفیگریشن
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "socialconnect-app.firebaseapp.com",
            projectId: "socialconnect-app",
            storageBucket: "socialconnect-app.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:abcdef1234567890",
            measurementId: "G-ABCDEF1234",
            databaseURL: "https://socialconnect-app.firebaseio.com"
        };
        
        // Firebase کو انیشیلائز کریں
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        // Firebase سروسز
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database();
        const functions = firebase.functions();
        
        // جیو فائر اسٹور سیٹ اپ
        const geofirestore = new GeoFirestore.GeoFirestore(db);
        const geoPosts = geofirestore.collection('geoPosts');
        
        // گلوبل ویری ایبلز
        let currentUser = null;
        let userLocation = null;
        let watchId = null;
        let postsListener = null;
        
        // DOM ایلیمنٹس
        const modeToggle = document.querySelector('.mode-toggle input');
        const postForm = document.getElementById('post-form');
        const postsFeed = document.getElementById('posts-feed');
        const chatButton = document.getElementById('chat-button');
        const unreadCount = document.getElementById('unread-count');
        
        // ایونٹ لسٹنرز
        modeToggle.addEventListener('change', toggleHelpMode);
        postForm.addEventListener('submit', handlePostSubmit);
        chatButton.addEventListener('click', openChat);
        
        // ایپ انیشیلائزیشن
        function initApp() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    updateUserProfile();
                    startLocationTracking();
                    setupPostsListener();
                    setupChatListener();
                } else {
                    // اگر یوزر لاگ ان نہیں ہے تو لاگ ان پیج پر ری ڈائریکٹ کریں
                    window.location.href = '/login.html';
                }
            });
        }
        
        // یوزر پروفائل کو اپ ڈیٹ کریں
        function updateUserProfile() {
            const userAvatar = document.querySelectorAll('.user-avatar img, .user-profile img');
            const userName = document.querySelector('.user-info h3');
            
            userAvatar.forEach(img => {
                img.src = currentUser.photoURL || 'https://randomuser.me/api/portraits/lego/1.jpg';
                img.alt = currentUser.displayName;
            });
            
            if (userName) {
                userName.textContent = currentUser.displayName;
            }
            wow
            // یوزر ڈیٹا بیس سے اضافی معلومات لوڈ کریں
            db.collection('users').doc(currentUser.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        document.querySelector('.user-info p').textContent = 
                            modeToggle.checked ? 'Offering Help' : 'Seeking Help';
                        document.querySelector('.reputation span').textContent = 
                            `${userData.rating || '4.5'} (${userData.ratingCount || '10'})`;
                    }
                });
        }
        
        // لوکیشن ٹریکنگ شروع کریں
        function startLocationTracking() {
            if (navigator.geolocation) {
                // ریل ٹائم لوکیشن اپ ڈیٹس
                watchId = navigator.geolocation.watchPosition(
                    position => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // یوزر کی لوکیشن کو ڈیٹا بیس میں اپ ڈیٹ کریں
                        if (currentUser) {
                            rtdb.ref(`userLocations/${currentUser.uid}`).set({
                                coordinates: {
                                    latitude: userLocation.lat,
                                    longitude: userLocation.lng
                                },
                                lastUpdated: firebase.database.ServerValue.TIMESTAMP
                            });
                            
                            // پوسٹس کو دوبارہ لوڈ کریں تاکہ نئے فاصلے ظاہر ہوں
                            if (postsListener) {
                                postsListener();
                            }
                        }
                    },
                    error => {
                        console.error('Geolocation error:', error);
                        alert('Location access is required for this app to work properly.');
                    },
                    { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
                );
            } else {
                alert('Geolocation is not supported by your browser.');
            }
        }
        
        // پوسٹس لسٹنر سیٹ اپ کریں
        function setupPostsListener() {
            const locationFilter = document.querySelector('.location-filter select');
            const categoryFilter = document.querySelectorAll('.category-tags .tag');
            
            // ڈیفالٹ فلٹرز
            let radius = 8; // 8 کلومیٹر
            let category = 'All';
            
            // لوکیشن فلٹر ایونٹ
            locationFilter.addEventListener('change', () => {
                const value = locationFilter.value;
                if (value.includes('1 mile')) radius = 1.6;
                else if (value.includes('5 miles')) radius = 8;
                else if (value.includes('10 miles')) radius = 16;
                else if (value.includes('25 miles')) radius = 40;
                else radius = 10000; // تمام لوکیشنز
                
                if (postsListener) {
                    postsListener();
                }
            });
            
            // کیٹیگری فلٹر ایونٹس
            categoryFilter.forEach(tag => {
                tag.addEventListener('click', () => {
                    categoryFilter.forEach(t => t.classList.remove('active'));
                    tag.classList.add('active');
                    category = tag.textContent;
                    
                    if (postsListener) {
                        postsListener();
                    }
                });
            });
            
            // پوسٹس کو لوڈ اور ڈسپلے کریں
            postsListener = () => {
                if (!userLocation) return;
                
                // موجودہ پوسٹس کو صاف کریں
                postsFeed.innerHTML = '';
                
                // جیو کوئری بنائیں
                const query = geoPosts.near({
                    center: new firebase.firestore.GeoPoint(userLocation.lat, userLocation.lng),
                    radius: radius
                });
                
                // کیٹیگری فلٹر لاگو کریں
                let finalQuery = query;
                if (category !== 'All') {
                    finalQuery = query.where('category', '==', category);
                }
                
                // موڈ کے مطابق فلٹر کریں
                const isOfferingHelp = modeToggle.checked;
                finalQuery = finalQuery.where('isHelpRequest', '==', isOfferingHelp);
                
                // پوسٹس کو لوڈ کریں
                finalQuery.limit(20).get()
                    .then(snapshot => {
                        snapshot.docs.forEach(doc => {
                            const post = doc.data();
                            displayPost(post, doc.id);
                        });
                    })
                    .catch(error => {
                        console.error('Error loading posts:', error);
                    });
            };
            
            // پہلی بار پوسٹس لوڈ کریں
            postsListener();
        }
        
        // پوسٹ کو ڈسپلے کریں
        function displayPost(post, postId) {
            // فاصلے کا حساب لگائیں
            let distanceText = 'Unknown distance';
            if (userLocation && post.location) {
                const distance = calculateDistance(
                    userLocation.lat, 
                    userLocation.lng,
                    post.location.latitude,
                    post.location.longitude
                );
                distanceText = `${distance.toFixed(1)} km away`;
            }
            
            // تخلیق کا وقت فارمیٹ کریں
            const timeAgo = formatTimeAgo(post.createdAt?.toDate());
            
            // پوسٹ کارڈ بنائیں
            const postCard = document.createElement('article');
            postCard.className = 'post-card';
            postCard.dataset.postId = postId;
            postCard.innerHTML = `
                <div class="post-header">
                    <div class="post-avatar">
                        <img src="${post.userPhotoURL}" alt="${post.userName}">
                    </div>
                    <div class="post-user">
                        <h4>${post.userName}</h4>
                        <p>${post.isHelpRequest ? 'Seeking Help' : 'Offering Help'} • ${timeAgo}</p>
                    </div>
                    <div class="post-distance">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${distanceText}</span>
                    </div>
                </div>
                
                <div class="post-content">
                    <p>${post.content}</p>
                </div>
                
                <div class="post-tags">
                    <div class="post-tag">${post.category}</div>
                    ${post.tags?.map(tag => `<div class="post-tag">${tag}</div>`).join('') || ''}
                </div>
                
                <div class="post-actions">
                    <button class="action-button">
                        <i class="far fa-comment"></i>
                        <span>${post.comments?.length || 0} Comments</span>
                    </button>
                    <button class="help-button" data-post-id="${postId}">
                        ${post.isHelpRequest ? 'Offer Help' : 'Request Help'}
                    </button>
                </div>
            `;
            
            // ہیلپ بٹن کے لیے ایونٹ لسٹنر شامل کریں
            const helpButton = postCard.querySelector('.help-button');
            helpButton.addEventListener('click', handleHelpOffer);
            
            // فیڈ میں پوسٹ شامل کریں
            postsFeed.appendChild(postCard);
        }
        
        // ہیلپ موڈ کو ٹوگل کریں
        function toggleHelpMode(e) {
            const labels = document.querySelectorAll('.toggle-labels span');
            if (e.target.checked) {
                labels[0].classList.remove('active-label');
                labels[1].classList.add('active-label');
                document.getElementById('post-heading').textContent = 'Create a Help Offer';
                document.getElementById('post-content').placeholder = 
                    'What kind of help can you offer? Be specific about your skills and availability...';
            } else {
                labels[0].classList.add('active-label');
                labels[1].classList.remove('active-label');
                document.getElementById('post-heading').textContent = 'Create a Help Request';
                document.getElementById('post-content').placeholder = 
                    'What kind of help do you need? Be specific about your needs and timeframe...';
            }
            
            // پوسٹس کو دوبارہ لوڈ کریں
            if (postsListener) {
                postsListener();
            }
            
            // یوزر پروفائل کو اپ ڈیٹ کریں
            updateUserProfile();
        }
        
        // پوسٹ جمع کرائیں
        async function handlePostSubmit(e) {
            e.preventDefault();
            const content = document.getElementById('post-content').value.trim();
            const category = document.getElementById('post-category').value;
            
            if (!content || !category) {
                alert('Please fill all fields');
                return;
            }
            
            try {
                const isOfferingHelp = modeToggle.checked;
                
                // پوسٹ ڈیٹا تیار کریں
                const postData = {
                    userId: currentUser.uid,
                    userName: currentUser.displayName,
                    userPhotoURL: currentUser.photoURL || 'https://randomuser.me/api/portraits/lego/1.jpg',
                    content,
                    category,
                    isHelpRequest: !isOfferingHelp,
                    isHelpOffer: isOfferingHelp,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'active',
                    comments: [],
                    helpers: [],
                    tags: []
                };
                
                // جیو لوکیشن شامل کریں اگر دستیاب ہے
                if (userLocation) {
                    postData.location = new firebase.firestore.GeoPoint(
                        userLocation.lat,
                        userLocation.lng
                    );
                }
                
                // پوسٹ کو ڈیٹا بیس میں شامل کریں
                const docRef = await db.collection('posts').add(postData);
                
                // جیو لوکیشن اسٹور میں بھی شامل کریں
                if (userLocation) {
                    await geoPosts.add({
                        ...postData,
                        coordinates: new firebase.firestore.GeoPoint(
                            userLocation.lat,
                            userLocation.lng
                        )
                    });
                }
                
                // فارم ری سیٹ کریں
                e.target.reset();
                
                // کامیابی کا میسج
                alert('Post created successfully!');
                
            } catch (error) {
                console.error('Error creating post:', error);
                alert('Failed to create post. Please try again.');
            }
        }
        
        // ہیلپ کی پیشکش کریں
        async function handleHelpOffer(e) {
            const postId = e.target.dataset.postId;
            
            try {
                // پوسٹ کو ڈیٹا بیس سے حاصل کریں
                const postRef = db.collection('posts').doc(postId);
                const postDoc = await postRef.get();
                
                if (!postDoc.exists) {
                    alert('Post not found');
                    return;
                }
                
                const post = postDoc.data();
                
                // چیک کریں کہ یوزر اپنی ہی پوسٹ پر ہیلپ کی پیشکش نہیں کر رہا
                if (post.userId === currentUser.uid) {
                    alert('You cannot offer help on your own post');
                    return;
                }
                
                // یوزر کو ہیلپرز کی فہرست میں شامل کریں
                await postRef.update({
                    helpers: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                });
                
                // چیٹ سیشن بنائیں
                const chatId = [currentUser.uid, post.userId].sort().join('_');
                const chatRef = db.collection('chats').doc(chatId);
                
                await chatRef.set({
                    participants: [currentUser.uid, post.userId],
                    participantNames: [currentUser.displayName, post.userName],
                    participantPhotos: [
                        currentUser.photoURL || 'https://randomuser.me/api/portraits/lego/1.jpg',
                        post.userPhotoURL
                    ],
                    lastMessage: '',
                    lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                    postId: postId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                // ابتدائی میسج بھیجیں
                await chatRef.collection('messages').add({
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName,
                    text: `I'd like to ${post.isHelpRequest ? 'offer help' : 'request help'} for your post: "${post.content.substring(0, 50)}..."`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'system'
                });
                
                // بٹن کو اپ ڈیٹ کریں
                e.target.textContent = 'Connection Made';
                e.target.disabled = true;
                e.target.style.backgroundColor = 'var(--gray)';
                
                // کامیابی کا میسج
                alert(`Your ${post.isHelpRequest ? 'offer to help' : 'request for help'} has been sent! You can now chat with ${post.userName}.`);
                
            } catch (error) {
                console.error('Error offering help:', error);
                alert('Failed to send help offer. Please try again.');
            }
        }
        
        // چیٹ لسٹنر سیٹ اپ کریں
        function setupChatListener() {
            db.collection('chats')
                .where('participants', 'array-contains', currentUser.uid)
                .orderBy('lastMessageTime', 'desc')
                .onSnapshot(snapshot => {
                    let unread = 0;
                    
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added' || change.type === 'modified') {
                            // یہاں آپ چیٹس کی فہرست کو اپ ڈیٹ کر سکتے ہیں
                        }
                    });
                    
                    // ان ریڈ میسجز کی تعداد کو اپ ڈیٹ کریں
                    unreadCount.textContent = unread > 0 ? unread : '';
                });
        }
        
        // چیٹ ونڈو کھولیں
        function openChat() {
            // یہاں آپ ایک موڈل یا نئی ونڈو کھول سکتے ہیں جو چیٹس کو ڈسپلے کرے
            alert('Chat window would open here with all your conversations');
        }
        
        // فاصلے کا حساب لگانے کا فنکشن (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // زمین کا رداس کلومیٹر میں
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // وقت کو "X minutes ago" فارمیٹ میں تبدیل کریں
        function formatTimeAgo(date) {
            if (!date) return 'Just now';
            
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = Math.floor(seconds / 31536000);
            
            if (interval >= 1) return `${interval} year${interval === 1 ? '' : 's'} ago`;
            interval = Math.floor(seconds / 2592000);
            if (interval >= 1) return `${interval} month${interval === 1 ? '' : 's'} ago`;
            interval = Math.floor(seconds / 86400);
            if (interval >= 1) return `${interval} day${interval === 1 ? '' : 's'} ago`;
            interval = Math.floor(seconds / 3600);
            if (interval >= 1) return `${interval} hour${interval === 1 ? '' : 's'} ago`;
            interval = Math.floor(seconds / 60);
            if (interval >= 1) return `${interval} minute${interval === 1 ? '' : 's'} ago`;
            return 'Just now';
        }
        
        // ایپ کو شروع کریں
        initApp();
    </script>
</body>
</html>
